<div class="screen">
  <aside
    class="aside-chat"
    [ngClass]="menu ? ' w-3/12 min-w-64 h-screen ' : ' w-16 h-auto'"
  >
    <section
      class="w-full bg-white rounded-r-md flex flex-col h-full p-2"
      [ngClass]="!menu ? ' items-start ' : ''"
    >
      <div class="w-full flex items-center pl-4">
        <button (click)="toggleMenu()" class="h-12">
          <i class="pi pi-bars"></i>
        </button>
      </div>
      @if(menu){
      <hr />
      <div class="chat" #chatElement>
        @for (msg of chat; track $index) { @if(!msg.system){
        <div [class]="!checkMessageUser(msg) ? 'message' : 'my-message'">
          <p class="m-0 text-white">
            @if(!checkMessageUser(msg)){
            <span class="font-boldmr-1">{{ msg.user.username }}:</span>
            }
            {{ msg.content.message }}
          </p>
        </div>
        } @else {
        <div [ngClass]="systemMessageType(msg.type)">
          <p class="m-0 text-white text-center">
            <span class="font-bold mr-1 block w-100">Sistema </span>
            {{ msg.content.message }}
          </p>
        </div>
        } }
      </div>
      <div class="w-full">
        <input
          fluid
          type="text"
          pInputText
          [(ngModel)]="msg"
          [ngModelOptions]="{ standalone: true }"
          (keydown)="handleChatKeyDown($event)"
          placeholder="Digite sua mensagem..."
          maxlength="255"
        />
        <p-button fluid label="Enviar" (click)="sendNewMessage()" />
      </div>
      }
    </section>
  </aside>

  <div class="board-container">
    <div class="grid-board" #gridBoard (dragover)="onDragOver($event)" (drop)="dropToken($event)">
      @for (row of gridRows; track $index) {
      <div class="grid-row">
        @for (col of gridCols; track $index) {
        <div
          class="grid-cell"
          (click)="selectToken()"
          [attr.data-row]="row"
          [attr.data-col]="col"
          (dragover)="onDragOver($event)"
          (drop)="dropToken($event)">
      </div>
        }
      </div>
      } @for (token of tokens; track token.id) {
      <div
        class="token"
        [ngClass]="token.type"
        [style.top.px]="token.position.y"
        [style.left.px]="token.position.x"
        draggable="true"
        (click)="selectToken(token)"
        (dragstart)="startDragging($event, token)"
      >
        <img [src]="token.label || ''" [alt]="token.name" class="w-full h-full">
        @if(this.selected_token == token){
          <div 
          class="absolute top-[-92px] flex justify-center flex-wrap">
          <div class="flex justify-center w-full">
            <button class="bg-white mx-1 rounded-full hover:bg-zinc-300 cursor-pointer">
              <i class="pi pi-eye text-black p-2"></i>
            </button>
            @if(user.owner){
              <button class="bg-white mx-1 rounded-full hover:bg-zinc-300 cursor-pointer"
              (click)="deleteTokenFromBoard(token.id)">
                <i class="pi pi-trash text-black p-2"></i>
              </button>
            }
          </div>
            <p class="m-0 text-center font-medium min-w-max mt-1">{{token.name}}</p>
            <div class="bg-red-600 rounded-lg w-32">
              <p class="text-center font-medium text-sm">{{token.stats.maxhp || 0}}/{{token.stats.hp || 0}}</p>
            </div>
          </div>
        }
      </div>
      }
    </div>
  </div>

  <aside class="aside-tools">
    <div class="tools">
      <button class="h-12 w-full">
        <i class="pi pi-plus"></i>
      </button>
      <button class="h-12 w-full" >
        <i class="pi pi-shield"></i>
      </button>
      <button class="h-12 w-full">
        <i class="pi pi-sliders-v"></i>
      </button>
      @if(user.owner){
      <button class="h-12 w-full" (click)="openTokenModal()">
        <i class="pi pi-book"></i>
      </button>
    }
      <button (click)="exitWorld()" class="h-12 w-full">
        <i class="pi pi-sign-out"></i>
      </button>
    </div>
  </aside>
</div>

<p-dialog
  [(visible)]="showTokenModal"
  [style]="{ width: '50vw' }"
  [modal]="true"
  header="Tabuleiro"
>
  <p-tabView>
    <p-tabPanel header="Tokens">
      <div class="flex justify-end mb-4">
        <p-button
          label="Novo Token"
          icon="pi pi-plus"
          (click)="openNewTokenModal()"
        ></p-button>
      </div>

      <p-table class="w-full" [value]="tokenList">
        <ng-template pTemplate="header">
          <tr>
            <th>Imagem</th>
            <th>Nome</th>
            <th>Players</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-token>
          <tr>
            <td class="text-center">
              <img
                [src]="token.image"
                class="w-12 h-12"
                alt="token image"
              />
            </td>
            <td>{{ token.name }}</td>
            <td>{{ token.players ? token.players.join(", ") : '-'}}</td>
            <td class="text-center">
              <button
                pButton
                icon="pi pi-plus"
                class="p-button-text"
                (click)="addToken(token)"
                pTooltip="Inserir no Tabuleiro"
                tooltipPosition="top"
              ></button>
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-text"
                (click)="editToken(token)"
                pTooltip="Editar Token"
                tooltipPosition="top"
              ></button>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-text p-button-danger"
                (click)="deleteToken(token.id)"
                pTooltip="Deletar Token"
                tooltipPosition="top"
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>
    <p-tabPanel header="Backgrounds">
      <div class="flex justify-end mb-4">
        <p-button label="Novo Background" icon="pi pi-plus"></p-button>
      </div>
    </p-tabPanel>
  </p-tabView>
  
</p-dialog>

<p-dialog
  [(visible)]="showNewTokenModal"
  [style]="{ width: '50vw' }"
  [modal]="true"
  header="Novo Token"
>
  <form [formGroup]="tokenForm" (ngSubmit)="saveToken()">
    <div class="mb-2">
      <div class="flex flex-col gap-2">
        <app-label name="name" description="Nome" [required]="true" />
        <input 
          pInputText 
          id="name" 
          formControlName="name"
          [ngClass]="tokenForm.controls['name'].valid ? '' : 'ng-invalid ng-dirty'"
        />
        @if(!tokenForm.controls['name'].valid && tokenForm.controls['name'].dirty){
          <p class="text-red-500">Campo Obrigatório</p>
        }
      </div>
    </div>


    <div class="my-4">
      <div class="flex flex-col gap-2">
        <app-label name="type" description="Tipo" [required]="true" />
        <p-dropdown
          [options]="tokenTypes"
          formControlName="type"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione o tipo"
          [style]="{'width': '100%'}"
        ></p-dropdown>
      </div>
    </div>

    <div class="my-4">
      <div class="flex flex-col gap-2 mb-3">
        <app-label name="image" description="Imagem" [required]="true" />
          <div class="flex justify-evenly items-center">
            <img [src]="selectedImage || ''" class="bg-zinc-300 w-24 h-24 rounded-full object-cover" />
            <p-fileUpload
            mode="basic"
            chooseLabel="Escolher Imagem"
            [auto]="true"
            accept="image/*"
            (onSelect)="onImageSelect($event)"
            [maxFileSize]="1000000"
          ></p-fileUpload>  
          </div>  
      </div>
    </div>

    <div class="flex justify-end gap-2">
      <p-button label="Cancelar" severity="secondary" (click)="closeNewTokenModal()" />
      <p-button *ngIf="!editingToken" label="Criar" (click)="saveToken()" [disabled]="!this.tokenForm.valid"/>
      <p-button *ngIf="editingToken" label="Atualizar" (click)="updateToken()" [disabled]="!this.tokenForm.valid"/>
    </div>
  </form>
</p-dialog>

<p-toast />